<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Q2 Calendar — React + Tailwind Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-presets="react">
      const {useState, useEffect} = React;
      function App(){
       
  const today = new Date()
  const [viewYear, setViewYear] = useState(today.getFullYear())
  const [viewMonth, setViewMonth] = useState(today.getMonth()) // 0-11
  const [eventsByDate, setEventsByDate] = useState({})
  const [selectedDay, setSelectedDay] = useState(null)
  const [showModal, setShowModal] = useState(false)
  const [newTitle, setNewTitle] = useState('')
  const [newTime, setNewTime] = useState('09:00')
  const [newPriority, setNewPriority] = useState('Medium')
  const [animDate, setAnimDate] = useState(null)

  useEffect(()=>{ fetchEvents() }, [viewYear, viewMonth])

  async function fetchEvents(){
    try{
      const res = await fetch('/event/list')
      const data = await res.json()
      // Normalize events to objects keyed by YYYY-MM-DD
      const map = {}
      data.forEach(e=>{
        if(!e.date) return
        const d = new Date(e.date)
        const key = d.toISOString().slice(0,10)
        map[key] = map[key] || []
        map[key].push(e)
      })
      setEventsByDate(map)
    }catch(err){
      console.warn('fetch events failed', err)
    }
  }

  function startPrevMonth(){
    if(viewMonth === 0){ setViewMonth(11); setViewYear(y=>y-1)} else setViewMonth(m=>m-1)
  }
  function startNextMonth(){
    if(viewMonth === 11){ setViewMonth(0); setViewYear(y=>y+1)} else setViewMonth(m=>m+1)
  }

  function monthMatrix(year, month){
    const first = new Date(year, month, 1)
    const startDay = first.getDay() // 0 Sun - 6 Sat
    const daysInMonth = new Date(year, month+1, 0).getDate()
    const matrix = []
    let row = Array(startDay).fill(null)
    for(let d=1; d<=daysInMonth; d++){
      row.push(new Date(year, month, d))
      if(row.length===7){ matrix.push(row); row = [] }
    }
    if(row.length) matrix.push([...row, ...Array(7-row.length).fill(null)])
    return matrix
  }

  function openAddModal(dateObj){
    setSelectedDay(dateObj)
    setNewTitle('')
    setNewTime('09:00')
    setNewPriority('Medium')
    setShowModal(true)
  }

  async function submitNew(e){
    e.preventDefault()
    if(!selectedDay) return
    // compose ISO datetime from selectedDay + time
    const datePart = selectedDay.toISOString().slice(0,10)
    const [hh, mm] = newTime.split(':')
    const iso = `${datePart}T${hh.padStart(2,'0')}:${mm.padStart(2,'0')}:00`
    const payload = { title: newTitle || 'Untitled', date: iso, priority: newPriority, duration: 30 }
    try{
      const res = await fetch('/event/add', {method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)})
      const j = await res.json()
      // optimistic UI update
      const key = datePart
      setEventsByDate(prev=>({ ...prev, [key]: [ ...(prev[key]||[]), j.event ] }))
      setAnimDate(key)
      // animate for 2s
      setTimeout(()=> setAnimDate(null), 2000)
      setShowModal(false)
    }catch(err){
      console.error(err)
      alert('Failed to add reminder — check backend')
    }
  }

  const matrix = monthMatrix(viewYear, viewMonth)
  const monthName = new Date(viewYear, viewMonth).toLocaleString(undefined, {month:'long'})

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-yellow-50 p-6">
      <div className="max-w-5xl mx-auto">
        <header className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-extrabold text-slate-800">Q2 — Monthly Planner</h1>
            <p className="text-sm text-slate-500">Colorful calendar with reminders, animations & auto-schedule.</p>
          </div>
          <div className="flex items-center gap-3">
            <button onClick={startPrevMonth} className="px-3 py-2 rounded-lg bg-white shadow">◀</button>
            <div className="text-center">
              <div className="font-semibold">{monthName} {viewYear}</div>
            </div>
            <button onClick={startNextMonth} className="px-3 py-2 rounded-lg bg-white shadow">▶</button>
          </div>
        </header>

        <div className="bg-white rounded-2xl shadow p-4">
          <div className="grid grid-cols-7 gap-2 text-center mb-2 text-sm text-slate-500">
            {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=> <div key={d} className="py-2">{d}</div>)}
          </div>

          {/* Month grid */}
          <div className="grid grid-cols-7 gap-3">
            {matrix.flat().map((day, idx)=>{
              const key = day ? day.toISOString().slice(0,10) : `empty-${idx}`
              const events = day ? (eventsByDate[key] || []) : []
              const isToday = day && (day.toDateString() === (new Date()).toDateString())
              const isAnim = animDate === key
              return (
                <div key={key} className={`min-h-[110px] p-2 rounded-lg transition-transform duration-300 ${day? 'bg-gradient-to-br from-white to-slate-50':'bg-transparent'} ${isAnim? 'scale-105 ring-4 ring-pink-300': ''}`}>
                  {!day ? <div/> : (
                    <div className="flex flex-col h-full">
                      <div className="flex items-center justify-between mb-2">
                        <div className={`w-8 h-8 flex items-center justify-center rounded-full font-medium ${isToday? 'bg-indigo-600 text-white':'text-slate-600'}`}>{day.getDate()}</div>
                        <button onClick={()=>openAddModal(day)} className="text-xs px-2 py-1 rounded bg-indigo-50 text-indigo-600">+ Add</button>
                      </div>

                      <div className="flex-1 overflow-hidden">
                        {events.slice(0,3).map((ev,i)=> (
                          <div key={ev.id} className={`mb-1 truncate text-xs p-1 rounded-md ${ev.priority==='High'? 'bg-red-100 text-red-800':'bg-green-50 text-green-800'}`}>
                            {ev.title} {ev.date? new Date(ev.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}): ''}
                          </div>
                        ))}
                        {events.length>3 && <div className="text-xs text-slate-400">+{events.length-3} more</div>}
                      </div>
                    </div>
                  )}
                </div>
              )
            })}
          </div>
        </div>

      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
          <form onSubmit={submitNew} className="bg-white rounded-2xl p-6 w-[420px] shadow-lg animate-fade-in">
            <h3 className="text-lg font-semibold mb-3">Add Reminder — {selectedDay.toDateString()}</h3>
            <label className="block text-sm text-slate-600">Title</label>
            <input value={newTitle} onChange={e=>setNewTitle(e.target.value)} className="w-full p-2 border rounded mb-3" placeholder="e.g. Study ML" required />
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm text-slate-600">Time</label>
                <input type="time" value={newTime} onChange={e=>setNewTime(e.target.value)} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm text-slate-600">Priority</label>
                <select value={newPriority} onChange={e=>setNewPriority(e.target.value)} className="w-full p-2 border rounded">
                  <option>High</option>
                  <option>Medium</option>
                  <option>Low</option>
                </select>
              </div>
            </div>

            <div className="mt-4 flex justify-end gap-3">
              <button type="button" onClick={()=>setShowModal(false)} className="px-4 py-2 rounded bg-slate-100">Cancel</button>
              <button className="px-4 py-2 rounded bg-indigo-600 text-white">Add Reminder</button>
            </div>
          </form>
        </div>
      )}

      <style>{`
        @keyframes pulse-ring { 0% { transform: scale(0.98); opacity: 0.9 } 50% { transform: scale(1.03); opacity: 1 } 100% { transform: scale(0.98); opacity: 0.9 } }
        .animate-fade-in { animation: fade-in 220ms ease-out both }
        @keyframes fade-in { from { opacity: 0; transform: translateY(8px) } to { opacity:1; transform: translateY(0) } }
        .ring-pink-300 { box-shadow: 0 0 0 6px rgba(236,72,153,0.12) }
      `}</style>
    </div>
  )
}
      
      ReactDOM.createRoot(document.getElementById('root')).render(<App />)
    </script>
  </body>
</html>
